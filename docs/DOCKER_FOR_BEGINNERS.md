# Docker 初心者ガイド

## Dockerって何？

**Dockerは「アプリを箱に入れて動かす」技術です。**

### 例え話で理解する

想像してください：

🏠 **あなたのパソコン** = 一軒家
📦 **Docker** = 組み立て式のプレハブ小屋

普通、新しいソフトウェア（例：データベース）をインストールすると：
- 家の中に直接設置する
- 設定ファイルが家のあちこちに散らばる
- アンインストールが大変
- 他のソフトと競合することがある

Dockerを使うと：
- 庭にプレハブ小屋を建てる（家を汚さない）
- 必要なものが全部小屋の中に入っている
- 使わなくなったら小屋ごと撤去できる
- 他のソフトと干渉しない

## なぜDockerを使うの？

### 1. 簡単にセットアップできる

**Dockerなしの場合：**
```
1. DynamoDBをダウンロード
2. Javaをインストール
3. 環境変数を設定
4. 設定ファイルを編集
5. 起動コマンドを覚える
→ 30分〜1時間かかる 😰
```

**Dockerありの場合：**
```bash
docker-compose up
→ 10秒で完了 🎉
```

### 2. 環境を汚さない

- パソコンに直接インストールしない
- 使い終わったら跡形もなく削除できる
- 他のプロジェクトと干渉しない

### 3. みんな同じ環境で動く

- 開発者Aのパソコンでも
- 開発者Bのパソコンでも
- 本番サーバーでも
→ 全く同じように動く！

## 今回のプロジェクトでの構成

```
あなたのパソコン（macOS）
│
├─ フロントエンド（ブラウザで表示）
│   ポート: 5173
│   役割: 3D原子モデルを表示
│   起動: npm run dev
│
├─ APIサーバー（Node.js）
│   ポート: 3000
│   役割: データベースとやり取り
│   起動: npm run api:dev
│
└─ 📦 Dockerの中（仮想環境）
    │
    ├─ DynamoDB Local（データベース）
    │   ポート: 8000
    │   役割: 元素データを保存
    │   起動: docker-compose up
    │
    └─ DynamoDB Admin（管理画面）
        ポート: 8001
        役割: データをブラウザで見る
        起動: docker-compose up（自動）
```

## docker-compose.yml が何をしているか

このファイルは「Dockerで動かすもののレシピ」です。

```yaml
services:
  dynamodb-local:        # ← DynamoDBという名前の箱を作る
    image: amazon/dynamodb-local:latest  # ← この設計図を使う
    ports:
      - "8000:8000"      # ← ポート8000で外から接続できる
    volumes:
      - ./dynamodb-data:/home/dynamodblocal/data  # ← データをパソコンに保存
```

### 分解して説明：

#### 1. `services:`
「これから作る箱のリスト」

#### 2. `dynamodb-local:`
「DynamoDBという名前の箱」

#### 3. `image: amazon/dynamodb-local:latest`
「Amazonが用意した設計図を使う」
- Dockerは設計図（イメージ）から箱（コンテナ）を作る
- 最初は自動でダウンロードされる

#### 4. `ports: "8000:8000"`
「箱の中のポート8000を、外のポート8000につなぐ」

```
パソコン（外）          Docker（中）
    8000     ←→      8000
     ↑               ↑
  ここに接続      DynamoDBが待機
```

#### 5. `volumes:`
「データをパソコンに保存」
- Dockerの箱を壊してもデータは残る
- `dynamodb-data/` フォルダに保存される

## 各コマンドが何をしているか

### 1. `npm run db:start`
実行内容: `docker-compose up -d`

```
┌─────────────────────────────────┐
│ 1. docker-compose.ymlを読む     │
├─────────────────────────────────┤
│ 2. 必要な設計図をダウンロード    │
│    （初回のみ）                  │
├─────────────────────────────────┤
│ 3. 箱を2つ作る                   │
│    - DynamoDB Local             │
│    - DynamoDB Admin             │
├─────────────────────────────────┤
│ 4. バックグラウンドで起動        │
│    (-d = detached mode)         │
└─────────────────────────────────┘

結果:
✅ DynamoDB Localが起動（ポート8000）
✅ DynamoDB Adminが起動（ポート8001）
✅ ターミナルは操作可能
```

確認方法:
```bash
docker ps
# 起動中の箱の一覧が表示される
```

### 2. `npm run db:setup`
実行内容: `tsx scripts/setup-local-db.ts`

```
┌─────────────────────────────────┐
│ 1. localhost:8000に接続          │
│    （DynamoDB Localに接続）      │
├─────────────────────────────────┤
│ 2. Elementsテーブルを作成        │
│    （データを入れる箱を作る）    │
├─────────────────────────────────┤
│ 3. 元素データを投入              │
│    H, He, C, O, Fe, Au, No, Lr  │
│    (elementsDB.tsから読み込む)   │
└─────────────────────────────────┘

結果:
✅ テーブル作成完了
✅ 8件の元素データが保存された
```

### 3. `npm run api:dev`
実行内容: `tsx watch server/local-api.ts`

```
┌─────────────────────────────────┐
│ 1. Express.jsサーバーを起動      │
├─────────────────────────────────┤
│ 2. localhost:8000に接続          │
│    （DynamoDB Localと通信）      │
├─────────────────────────────────┤
│ 3. ポート3000で待機              │
│    APIリクエストを受け付ける     │
└─────────────────────────────────┘

利用可能なAPI:
GET  /api/elements           # 全元素取得
GET  /api/elements/1         # 水素を取得
GET  /api/elements/symbol/Au # 金を取得
POST /api/elements           # 新規追加
...
```

### 4. `npm run dev`
実行内容: `vite`

```
┌─────────────────────────────────┐
│ 1. Vite開発サーバー起動          │
├─────────────────────────────────┤
│ 2. ポート5173で待機              │
│    ブラウザからアクセス可能      │
├─────────────────────────────────┤
│ 3. localhost:3000に接続          │
│    APIサーバーからデータ取得     │
└─────────────────────────────────┘

結果:
✅ ブラウザで3D原子モデルが表示
✅ 周期表から元素を選択できる
```

## 全体の流れ（図解）

```
┌──────────────────────────────────────────────────┐
│              ブラウザ (localhost:5173)            │
│         ┌─────────────────────────────┐          │
│         │  3D原子モデル表示            │          │
│         │  周期表UI                    │          │
│         └────────────┬────────────────┘          │
└──────────────────────┼───────────────────────────┘
                       │ HTTP通信
                       ↓
┌──────────────────────────────────────────────────┐
│       APIサーバー (localhost:3000)                │
│  ┌────────────────────────────────────┐          │
│  │ Express.js                          │          │
│  │ ・元素データを取得                   │          │
│  │ ・CRUDエンドポイント提供             │          │
│  └──────────────┬─────────────────────┘          │
└─────────────────┼────────────────────────────────┘
                  │ DynamoDB通信
                  ↓
┌──────────────────────────────────────────────────┐
│            📦 Docker (仮想環境)                   │
│  ┌──────────────────────────────────┐            │
│  │  DynamoDB Local (localhost:8000) │            │
│  │  ┌────────────────────────────┐  │            │
│  │  │ Elementsテーブル            │  │            │
│  │  │ ├─ 1: H (水素)             │  │            │
│  │  │ ├─ 2: He (ヘリウム)        │  │            │
│  │  │ ├─ 6: C (炭素)             │  │            │
│  │  │ └─ ...                     │  │            │
│  │  └────────────────────────────┘  │            │
│  └──────────────────────────────────┘            │
│                                                   │
│  ┌──────────────────────────────────┐            │
│  │  DynamoDB Admin (localhost:8001) │            │
│  │  （ブラウザで見られる管理画面）   │            │
│  └──────────────────────────────────┘            │
└──────────────────────────────────────────────────┘
```

## 実際の起動手順（Dockerあり）

### ターミナル1️⃣：データベース起動
```bash
cd /Users/tomoyasaito/vscode/three-house

# Docker箱を起動
npm run db:start

# 確認（起動中のDocker箱が表示される）
docker ps

# データを投入
npm run db:setup
```

### ターミナル2️⃣：APIサーバー起動
```bash
cd /Users/tomoyasaito/vscode/three-house

# APIサーバー起動
npm run api:dev

# 以下が表示されればOK：
# 🚀 ローカルAPIサーバーが起動しました
# 📡 http://localhost:3000
```

### ターミナル3️⃣：フロントエンド起動
```bash
cd /Users/tomoyasaito/vscode/three-house

# フロントエンド起動
npm run dev

# 以下が表示されればOK：
# ➜  Local: http://localhost:5173/
```

### ブラウザで確認
- **フロントエンド**: http://localhost:5173
- **DynamoDB管理画面**: http://localhost:8001

## Dockerなしで動かす場合

現在の設定（`.env`）:
```env
VITE_USE_REMOTE_DB=false  # ← ローカルデータを使う
```

この場合の動き：
```
ブラウザ (localhost:5173)
    ↓
elementService.ts
    ↓
elementsDB.ts（JavaScriptファイル）
```

起動手順:
```bash
# これだけでOK！
npm run dev
```

## よくある質問

### Q1: Dockerを止めるには？
```bash
npm run db:stop
```

### Q2: データをリセットしたい
```bash
npm run db:stop
rm -rf dynamodb-data
npm run db:start
npm run db:setup
```

### Q3: Dockerが起動しているか確認したい
```bash
docker ps
```

### Q4: Dockerのログを見たい
```bash
docker logs periodic-table-dynamodb
```

### Q5: 完全にクリーンアップしたい
```bash
npm run db:stop
docker system prune -a  # 全てのDocker箱と設計図を削除
rm -rf dynamodb-data
```

## まとめ

- **Docker**: アプリを箱に入れて動かす技術
- **docker-compose.yml**: 箱の設計図
- **docker-compose up**: 箱を作って起動
- **docker-compose down**: 箱を止めて削除

今回のプロジェクトでは、DynamoDB Localを簡単に起動するためにDockerを使っています！
